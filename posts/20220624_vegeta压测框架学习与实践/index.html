<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Vegeta压测工具学习与使用 - 实践出真知</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="学习并了解vegeta相关的逻辑" /><meta name="keywords" content='计算机/go, 内容/学习笔记, 计算机/压力测试, 计算机/vegeta' /><meta itemprop="name" content="Vegeta压测工具学习与使用">
<meta itemprop="description" content="学习并了解vegeta相关的逻辑"><meta itemprop="datePublished" content="2022-06-24T17:27:23+08:00" />
<meta itemprop="dateModified" content="2024-03-04T00:00:00+00:00" />
<meta itemprop="wordCount" content="4554">
<meta itemprop="keywords" content="计算机/go,内容/学习笔记,计算机/压力测试,计算机/vegeta," /><meta property="og:title" content="Vegeta压测工具学习与使用" />
<meta property="og:description" content="学习并了解vegeta相关的逻辑" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-24T17:27:23+08:00" />
<meta property="article:modified_time" content="2024-03-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Vegeta压测工具学习与使用"/>
<meta name="twitter:description" content="学习并了解vegeta相关的逻辑"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" /><link rel="prev" href="http://wtysos11.github.io/posts/20220624_%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E7%BB%BC%E8%BF%B0%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB/" /><link rel="next" href="http://wtysos11.github.io/posts/20220627_gopherfest2015_go_proverbs_rob_pike/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Vegeta压测工具学习与使用",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/wtysos11.github.io\/posts\/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5\/"
    },"genre": "posts","keywords": "计算机\/go, 内容\/学习笔记, 计算机\/压力测试, 计算机\/vegeta","wordcount":  4554 ,
    "url": "http:\/\/wtysos11.github.io\/posts\/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5\/","datePublished": "2022-06-24T17:27:23+08:00","dateModified": "2024-03-04T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="实践出真知"><span class="header-title-text">实践出真知</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li><li class="menu-item language-switch">
            <span role="button" aria-label="选择语言" title="选择语言"><i class="fa-solid fa-language fa-fw" aria-hidden="true"></i></span>
            <ul class="sub-menu"><li class="menu-item">没有更多翻译</li></ul>
          </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="实践出真知"><span class="header-title-text">实践出真知</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span><span class="menu-system-item language-switch">
              <span role="button" aria-label="选择语言" title="选择语言">简体中文<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden="true"></i></span>
              <select class="language-select" onchange="location = this.value;"><option disabled>没有更多翻译</option></select>
            </span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Vegeta压测工具学习与使用</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/%E5%BC%80%E6%BA%90%E4%BB%A3%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category" title="分类 - 开源代码学习笔记"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 开源代码学习笔记</a></span></div><div class="post-meta-line"><span title="发布于 2022-06-24 17:27:23"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-06-24">2022-06-24</time></span>&nbsp;<span title="更新于 2024-03-04 00:00:00"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2024-03-04">2024-03-04</time></span>&nbsp;<span title="4554 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 4600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 10 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#安装">安装</a></li>
    <li><a href="#简易使用">简易使用</a></li>
    <li><a href="#从golang程序中启动vegeta">从golang程序中启动Vegeta</a>
      <ul>
        <li><a href="#attack分析">Attack分析</a></li>
        <li><a href="#读取文件设计动态访问">读取文件设计动态访问</a></li>
        <li><a href="#新的demo">新的demo</a></li>
      </ul>
    </li>
    <li><a href="#服务端代码与之前一致">服务端代码与之前一致</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h1 id="vegeta压测工具学习与使用" class="heading-element">
  <a href="#vegeta%e5%8e%8b%e6%b5%8b%e5%b7%a5%e5%85%b7%e5%ad%a6%e4%b9%a0%e4%b8%8e%e4%bd%bf%e7%94%a8" class="heading-mark"></a>Vegeta压测工具学习与使用</h1><blockquote>
<p>目标：</p>
<ol>
<li>能够在命令行下使用Vegeta对指定API进行测试</li>
<li>了解如何导出结果，以及能获得什么样的结果(P99,P99.9,QPS)</li>
<li>探索能否导出其他结果，是否能够执行复杂命令或简易脚本等</li>
</ol>
<p>时间比较紧迫，预计两到三个小时内完成</p>
</blockquote>
<p>参考资料：</p>
<ul>
<li><a href="https://github.com/tsenart/vegeta"target="_blank" rel="external nofollow noopener noreferrer">source-tsenart/vegeta</a></li>
<li><a href="https://www.hi-linux.com/posts/4650.html"target="_blank" rel="external nofollow noopener noreferrer">中文介绍</a></li>
</ul>
<h2 id="安装" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85" class="heading-mark"></a>安装</h2><p>在确定GOBIN在PATH内时，直接使用<code>go get -u github.com/tsenart/vegeta </code>即可完成安装。</p>
<h2 id="简易使用" class="heading-element">
  <a href="#%e7%ae%80%e6%98%93%e4%bd%bf%e7%94%a8" class="heading-mark"></a>简易使用</h2><p>在iris服务器中开启一个简单的router</p>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/test/{name}&#34;</span><span class="p">,</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="nx">name</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Params</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span></span></span></code></pre></div><p>声明一个简单的txt（必须带上HTTP）</p>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">GET http://localhost:8080/test/name1
</span></span><span class="line"><span class="cl">GET http://localhost:8080/test/name2
</span></span><span class="line"><span class="cl">GET http://localhost:8080/test/name3</span></span></code></pre></div><p>执行命令<code>vegeta attack -targets ./test.txt -duration=30s -rate=10000 &gt; result.bin</code>，即可开启服务，进行测试。（PS：不知道为什么<code>-rate=0</code>不支持，会报错误要求一个大于0的数）</p>
<p>执行<code>vegeta report result.bin</code>即可拿到执行报告</p>
<div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Requests      [total, rate]            300000, 9985.22
</span></span><span class="line"><span class="cl">Duration      [total, attack, wait]    31.3856523s, 30.044419s, 1.3412333s
</span></span><span class="line"><span class="cl">Latencies     [mean, 50, 95, 99, max]  1.367112453s, 4.50456ms, 4.511788108s, 6.305999861s, 7.6157462s
</span></span><span class="line"><span class="cl">Bytes In      [total, mean]            0, 0.00
</span></span><span class="line"><span class="cl">Bytes Out     [total, mean]            0, 0.00
</span></span><span class="line"><span class="cl">Success       [ratio]                  48.38%
</span></span><span class="line"><span class="cl">Status Codes  [code:count]             200:145132  0:154868
</span></span><span class="line"><span class="cl">Error Set:
</span></span><span class="line"><span class="cl">Get http://localhost:8080/test/name3: dial tcp 0.0.0.0:0-&gt;[::1]:8080: bind: An operation on a socket could not be performed because the system lacked su
</span></span><span class="line"><span class="cl">fficient buffer space or because a queue was full.
</span></span><span class="line"><span class="cl">Get http://localhost:8080/test/name1: dial tcp 0.0.0.0:0-&gt;[::1]:8080: bind: An operation on a socket could not be performed because the system lacked su
</span></span><span class="line"><span class="cl">fficient buffer space or because a queue was full.
</span></span><span class="line"><span class="cl">Get http://localhost:8080/test/name2: dial tcp 0.0.0.0:0-&gt;[::1]:8080: bind: An operation on a socket could not be performed because the system lacked su
</span></span><span class="line"><span class="cl">fficient buffer space or because a queue was full.
</span></span><span class="line"><span class="cl">Get http://localhost:8080/test/name1: dial tcp 0.0.0.0:0-&gt;[::1]:8080: connectex: Only one usage of each socket address (protocol/network address/port) i
</span></span><span class="line"><span class="cl">s normally permitted.
</span></span><span class="line"><span class="cl">Get http://localhost:8080/test/name2: dial tcp 0.0.0.0:0-&gt;[::1]:8080: connectex: Only one usage of each socket address (protocol/network address/port) i
</span></span><span class="line"><span class="cl">s normally permitted.
</span></span><span class="line"><span class="cl">Get http://localhost:8080/test/name3: dial tcp 0.0.0.0:0-&gt;[::1]:8080: connectex: Only one usage of each socket address (protocol/network address/port) i
</span></span><span class="line"><span class="cl">s normally permitted.</span></span></code></pre></div><p>此外还支持golang的库内部链接，例如：</p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">vegeta</span> <span class="s">&#34;github.com/tsenart/vegeta/v12/lib&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rate</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Rate</span><span class="p">{</span><span class="nx">Freq</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">Per</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">duration</span> <span class="o">:=</span> <span class="mi">4</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="nx">targeter</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nf">NewStaticTargeter</span><span class="p">(</span><span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Method</span><span class="p">:</span> <span class="s">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">URL</span><span class="p">:</span>    <span class="s">&#34;http://localhost:8080/test&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//测试的实现需要基于Attacker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">attacker</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nf">NewAttacker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">metrics</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Metrics</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">res</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">attacker</span><span class="p">.</span><span class="nf">Attack</span><span class="p">(</span><span class="nx">targeter</span><span class="p">,</span> <span class="nx">rate</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="s">&#34;Big Bang!&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//res是Result向量，执行结果。拿到的时候代表一次执行已经结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">metrics</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metrics</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;99th percentile: %s\n&#34;</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">Latencies</span><span class="p">.</span><span class="nx">P99</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="从golang程序中启动vegeta" class="heading-element">
  <a href="#%e4%bb%8egolang%e7%a8%8b%e5%ba%8f%e4%b8%ad%e5%90%af%e5%8a%a8vegeta" class="heading-mark"></a>从golang程序中启动Vegeta</h2><p>由于需要输入不同的元素或者控制元素的数量，一个想法是直接生成一个百万行的文件并插入，另外一个想法是直接在程序内启动。出于对更灵活的性能的追求，我还是想尝试一下后者。</p>
<p>使用DEBUG单步调试，发现<code>attack.Attack</code></p>
<p>根据<a href="https://github.com/tsenart/vegeta/issues/330"target="_blank" rel="external nofollow noopener noreferrer">issue</a>中的回复可以看到，只要返回一个能够产生Targeter的函数即可。其中Targeter也是一个函数（类型为<code>type Targeter func(*Target) error</code>，而Target在我的理解中是即将发送的请求，原文为<code>HTTP request blueprint</code>）</p>
<p>而例子中的<code>atacker.Attack</code>的返回值是一个channel，相当于是<code>vegeta attack</code>命令。其中<code>attacker</code>对象由<code>NewAttacker</code>创建，可以指定一些参数（比如最大并行数量等）</p>
<h3 id="attack分析" class="heading-element">
  <a href="#attack%e5%88%86%e6%9e%90" class="heading-mark"></a>Attack分析</h3><div class="highlight" id="id-5"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Attack reads its Targets from the passed Targeter and attacks them at
</span></span></span><span class="line"><span class="cl"><span class="c1">// the rate specified by the Pacer. When the duration is zero the attack
</span></span></span><span class="line"><span class="cl"><span class="c1">// runs until Stop is called. Results are sent to the returned channel as soon
</span></span></span><span class="line"><span class="cl"><span class="c1">// as they arrive and will have their Attack field set to the given name.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Attacker</span><span class="p">)</span> <span class="nf">Attack</span><span class="p">(</span><span class="nx">tr</span> <span class="nx">Targeter</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">Pacer</span><span class="p">,</span> <span class="nx">du</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//最大并发数的限制由Attacker提供
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">workers</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">workers</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">workers</span> <span class="p">&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">maxWorkers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">workers</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">maxWorkers</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//返回的结果队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">results</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">Result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ticks</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="c1">//ticks是控制速度用的，attack需要消费ticks中的数据才能继续执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workers</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">//wait group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">go</span> <span class="nx">a</span><span class="p">.</span><span class="nf">attack</span><span class="p">(</span><span class="nx">tr</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">ticks</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span><span class="c1">//使用go协程来控制。其中results被放入，在其中产生
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//defer的实现上类似于栈，因此是先关闭ticks队列，再等待所有的a.attack函数执行完毕，最后关闭results队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">ticks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">began</span><span class="p">,</span> <span class="nx">count</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span> <span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elapsed</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">began</span><span class="p">)</span><span class="c1">//拿到过去的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">du</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">elapsed</span> <span class="p">&gt;</span> <span class="nx">du</span> <span class="p">{</span><span class="c1">//du即为duration，如果持续时间超过则直接结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">wait</span><span class="p">,</span> <span class="nx">stop</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Pace</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span><span class="c1">//Pacer，负责控制速度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">stop</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="c1">//如果发完了，则返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">wait</span><span class="p">)</span><span class="c1">//等待剩余时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">workers</span> <span class="p">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">maxWorkers</span> <span class="p">{</span><span class="c1">//如果并发没有打满
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">case</span> <span class="nx">ticks</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}:</span><span class="c1">//向ticks中传入数据。由于ticks没有缓冲，所以如果其数据没有消耗掉则不能放入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">count</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">					<span class="k">continue</span>
</span></span><span class="line"><span class="cl">				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">a</span><span class="p">.</span><span class="nx">stopch</span><span class="p">:</span><span class="c1">//接受到停止信号，直接中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">return</span>
</span></span><span class="line"><span class="cl">				<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// all workers are blocked. start one more and try again
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// 动态调整并发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">workers</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">					<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">go</span> <span class="nx">a</span><span class="p">.</span><span class="nf">attack</span><span class="p">(</span><span class="nx">tr</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">ticks</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">ticks</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">count</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">a</span><span class="p">.</span><span class="nx">stopch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">results</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><code>attcker.attack</code></p>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Attacker</span><span class="p">)</span> <span class="nf">attack</span><span class="p">(</span><span class="nx">tr</span> <span class="nx">Targeter</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">workers</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">ticks</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="nx">results</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="o">*</span><span class="nx">Result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">workers</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span><span class="c1">//完成后返回，除非ticks被关闭不然也不会执行到这里。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="k">range</span> <span class="nx">ticks</span> <span class="p">{</span><span class="c1">//每次要消费ticks的数据才能继续进行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">results</span> <span class="o">&lt;-</span> <span class="nx">a</span><span class="p">.</span><span class="nf">hit</span><span class="p">(</span><span class="nx">tr</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span><span class="c1">//数据写入到results channel之中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Attacker</span><span class="p">)</span> <span class="nf">hit</span><span class="p">(</span><span class="nx">tr</span> <span class="nx">Targeter</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span> <span class="p">=</span> <span class="nx">Result</span><span class="p">{</span><span class="nx">Attack</span><span class="p">:</span> <span class="nx">name</span><span class="p">}</span> <span class="c1">//最终返回的结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tgt</span> <span class="nx">Target</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">a</span><span class="p">.</span><span class="nx">seqmu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span><span class="c1">//加锁，保证对临街资源a.seq的访问与写入是正确的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">res</span><span class="p">.</span><span class="nx">Timestamp</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">began</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">began</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">.</span><span class="nx">Seq</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">seq</span>
</span></span><span class="line"><span class="cl">	<span class="nx">a</span><span class="p">.</span><span class="nx">seq</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="nx">a</span><span class="p">.</span><span class="nx">seqmu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span><span class="c1">//解锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Latency</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">Timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">res</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处的tr就是传入的targeter的终点，这也解释了这个函数是干什么的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 传入的tgt实际上没有任何意义，看做是返回值会更好一些
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">tr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tgt</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">res</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">.</span><span class="nx">Method</span> <span class="p">=</span> <span class="nx">tgt</span><span class="p">.</span><span class="nx">Method</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">.</span><span class="nx">URL</span> <span class="p">=</span> <span class="nx">tgt</span><span class="p">.</span><span class="nx">URL</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tgt</span><span class="p">.</span><span class="nf">Request</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">res</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">name</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-Vegeta-Attack&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-Vegeta-Seq&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatUint</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">Seq</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">chunked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">req</span><span class="p">.</span><span class="nx">TransferEncoding</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">TransferEncoding</span><span class="p">,</span> <span class="s">&#34;chunked&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">res</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">body</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Reader</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">maxBody</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">body</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">LimitReader</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">maxBody</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">res</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">res</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">.</span><span class="nx">BytesIn</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">Body</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">BytesOut</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ContentLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="p">=</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">);</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="p">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Error</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Status</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">.</span><span class="nx">Headers</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Header</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">res</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="读取文件设计动态访问" class="heading-element">
  <a href="#%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6%e8%ae%be%e8%ae%a1%e5%8a%a8%e6%80%81%e8%ae%bf%e9%97%ae" class="heading-mark"></a>读取文件设计动态访问</h3><p>因此，动态访问的实现原理就很明确了：</p>
<ol>
<li>实现一个能够返回targeter的函数，并将id作为参数传入其中，如同<a href="https://github.com/tsenart/vegeta/issues/330"target="_blank" rel="external nofollow noopener noreferrer">这个issue</a>所写的那样，或者这个<a href="https://github.com/hairqles/vegeta-targeter/blob/master/main.go"target="_blank" rel="external nofollow noopener noreferrer">example code</a></li>
<li>如何让其中的内容不同：
<ol>
<li><a href="https://github.com/hairqles/vegeta-targeter/blob/master/main.go"target="_blank" rel="external nofollow noopener noreferrer">example code</a>使用了随机数。在我的需求中，我可以将所需要的文件读入其中作为数组，然后使用随机数索引访问。</li>
<li>直接使用函数内变量，利用闭包的性质。考虑到targeter每次都会被调用（<code>attack.go</code>的第365行），因此计数器向上移动的时候就可以实现遍历。</li>
</ol>
</li>
</ol>
<p>下面做了一个小的demo来展示这个思想，服务端会接受一个<code>/test/nameX</code>作为接受变量，发送端会发送随机的<code>/test/XXX</code>过去。</p>
<h4 id="服务端" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af" class="heading-mark"></a>服务端</h4><div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/kataras/iris/v12&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">prometheusMiddleware</span> <span class="s">&#34;github.com/iris-contrib/middleware/prometheus&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nf">registerCuckooFilter</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">registerPrometheus</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">registerCuckooFilter</span><span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="nx">filter</span> <span class="o">:=</span> <span class="nx">cuckooFilter</span><span class="p">.</span><span class="nx">CuckooFilter</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">test</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/test/{name}&#34;</span><span class="p">,</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="nx">name</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Params</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span><span class="nx">ok</span> <span class="o">:=</span> <span class="nx">test</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span><span class="nx">ok</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">test</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">++</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">test</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/get/{name}&#34;</span><span class="p">,</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="nx">name</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Params</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">val</span><span class="p">,</span><span class="nx">ok</span> <span class="o">:=</span> <span class="nx">test</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span><span class="nx">ok</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key number is %v&#34;</span><span class="p">,</span><span class="nx">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;key doestn&#39;t exist&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//batch操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//批量插入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//批量查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//批量删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">registerPrometheus</span><span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">iris</span><span class="p">.</span><span class="nx">Application</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="nx">m</span> <span class="o">:=</span> <span class="nx">prometheusMiddleware</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;serviceName&#34;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">OnErrorCode</span><span class="p">(</span><span class="nx">iris</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// error code handlers are not sharing the same middleware as other routes, so we have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// to call them inside their body.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">m</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Writef</span><span class="p">(</span><span class="s">&#34;Not Found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">iris</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sleep</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">4999</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">sleep</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Writef</span><span class="p">(</span><span class="s">&#34;Slept for %d milliseconds&#34;</span><span class="p">,</span> <span class="nx">sleep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/metrics&#34;</span><span class="p">,</span> <span class="nx">iris</span><span class="p">.</span><span class="nf">FromStd</span><span class="p">(</span><span class="nx">promhttp</span><span class="p">.</span><span class="nf">Handler</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h4 id="压测端" class="heading-element">
  <a href="#%e5%8e%8b%e6%b5%8b%e7%ab%af" class="heading-mark"></a>压测端</h4><div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bufio&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">vegeta</span> <span class="s">&#34;github.com/tsenart/vegeta/v12/lib&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rate</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Rate</span><span class="p">{</span><span class="nx">Freq</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">Per</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">duration</span> <span class="o">:=</span> <span class="mi">4</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="nx">targeter</span> <span class="o">:=</span> <span class="nf">NewCustomTargeter</span><span class="p">(</span><span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Method</span><span class="p">:</span> <span class="s">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">URL</span><span class="p">:</span>    <span class="s">&#34;http://localhost:8080/test&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//测试的实现需要基于Attacker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">attacker</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nf">NewAttacker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">metrics</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Metrics</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">res</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">attacker</span><span class="p">.</span><span class="nf">Attack</span><span class="p">(</span><span class="nx">targeter</span><span class="p">,</span> <span class="nx">rate</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="s">&#34;random&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metrics</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metrics</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;99th percentile: %s\n&#34;</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">Latencies</span><span class="p">.</span><span class="nx">P99</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewCustomTargeter</span><span class="p">(</span><span class="nx">target</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">)</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Targeter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//读取id文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//idData,err := readRealData()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//if err != nil{
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//	panic(err)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//cachedArray := make([]bool,len(idData))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tgt</span> <span class="o">*</span><span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//其中，tgt是作为指针传入的，是需要被修改的。后续HTTP请求的赋值都是来自tgt，所以看做是另外一个返回值会更好一些
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">*</span><span class="nx">tgt</span> <span class="p">=</span> <span class="nx">target</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tgt</span><span class="p">.</span><span class="nx">URL</span> <span class="o">+=</span> <span class="s">&#34;/custom&#34;</span><span class="o">+</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//tgt.Header = http.Header{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">readRealData</span><span class="p">()</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//读取id.txt文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">filePath</span> <span class="o">:=</span> <span class="s">&#34;../../resources/id.txt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_RDONLY</span><span class="p">,</span> <span class="mo">0666</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//数据格式为音频id，字符串`TRA_{albumid}_index`，albumid为6-10位数字,index为5位数字以内
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//将其作为字符串读取并写入到slices中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">idData</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">buf</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">idData</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">idData</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">idData</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>之后，通过发送请求<code>curl http://localhost:8080/get/custom54</code>就可以查看触发的数量。</p>
<p>最终输出结果除了一般的分位点（P99）之外，还有HDR图。</p>
<p><img loading="lazy" src="/assets/20220624_vegeta%e5%8e%8b%e6%b5%8b%e6%a1%86%e6%9e%b6%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5/vegeta_test.png" alt="HDR图" srcset="/assets/20220624_vegeta%e5%8e%8b%e6%b5%8b%e6%a1%86%e6%9e%b6%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5/vegeta_test.png?size=small, /assets/20220624_vegeta%e5%8e%8b%e6%b5%8b%e6%a1%86%e6%9e%b6%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5/vegeta_test.png?size=medium 1.5x, /assets/20220624_vegeta%e5%8e%8b%e6%b5%8b%e6%a1%86%e6%9e%b6%e5%ad%a6%e4%b9%a0%e4%b8%8e%e5%ae%9e%e8%b7%b5/vegeta_test.png?size=large 2x" data-title="HDR图" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Value<span class="o">(</span>ms<span class="o">)</span>    Percentile  TotalCount  1/<span class="o">(</span>1-Percentile<span class="o">)</span>
</span></span><span class="line"><span class="cl">0.000000     0.000000    <span class="m">0</span>           1.000000
</span></span><span class="line"><span class="cl">0.000000     0.100000    <span class="m">800</span>         1.111111
</span></span><span class="line"><span class="cl">0.000000     0.200000    <span class="m">1600</span>        1.250000
</span></span><span class="line"><span class="cl">41.403452    0.300000    <span class="m">2400</span>        1.428571
</span></span><span class="line"><span class="cl">97.939712    0.400000    <span class="m">3200</span>        1.666667
</span></span><span class="line"><span class="cl">142.381740   0.500000    <span class="m">4000</span>        2.000000
</span></span><span class="line"><span class="cl">162.678710   0.550000    <span class="m">4400</span>        2.222222
</span></span><span class="line"><span class="cl">183.896175   0.600000    <span class="m">4800</span>        2.500000
</span></span><span class="line"><span class="cl">203.870917   0.650000    <span class="m">5200</span>        2.857143
</span></span><span class="line"><span class="cl">222.808221   0.700000    <span class="m">5600</span>        3.333333
</span></span><span class="line"><span class="cl">241.782645   0.750000    <span class="m">6000</span>        4.000000
</span></span><span class="line"><span class="cl">252.824780   0.775000    <span class="m">6200</span>        4.444444
</span></span><span class="line"><span class="cl">279.751398   0.800000    <span class="m">6400</span>        5.000000
</span></span><span class="line"><span class="cl">307.471717   0.825000    <span class="m">6600</span>        5.714286
</span></span><span class="line"><span class="cl">339.415889   0.850000    <span class="m">6800</span>        6.666667
</span></span><span class="line"><span class="cl">371.413354   0.875000    <span class="m">7000</span>        8.000000
</span></span><span class="line"><span class="cl">390.505284   0.887500    <span class="m">7100</span>        8.888889
</span></span><span class="line"><span class="cl">408.344121   0.900000    <span class="m">7200</span>        10.000000
</span></span><span class="line"><span class="cl">427.964702   0.912500    <span class="m">7300</span>        11.428571
</span></span><span class="line"><span class="cl">453.307363   0.925000    <span class="m">7400</span>        13.333333
</span></span><span class="line"><span class="cl">483.224073   0.937500    <span class="m">7500</span>        16.000000
</span></span><span class="line"><span class="cl">504.911659   0.943750    <span class="m">7550</span>        17.777778
</span></span><span class="line"><span class="cl">526.433221   0.950000    <span class="m">7600</span>        20.000000
</span></span><span class="line"><span class="cl">554.693406   0.956250    <span class="m">7650</span>        22.857143
</span></span><span class="line"><span class="cl">583.532213   0.962500    <span class="m">7700</span>        26.666667
</span></span><span class="line"><span class="cl">612.195055   0.968750    <span class="m">7750</span>        32.000000
</span></span><span class="line"><span class="cl">629.163420   0.971875    <span class="m">7775</span>        35.555556
</span></span><span class="line"><span class="cl">647.068860   0.975000    <span class="m">7800</span>        40.000000
</span></span><span class="line"><span class="cl">667.629935   0.978125    <span class="m">7825</span>        45.714286
</span></span><span class="line"><span class="cl">691.831905   0.981250    <span class="m">7850</span>        53.333333
</span></span><span class="line"><span class="cl">729.039830   0.984375    <span class="m">7875</span>        64.000000
</span></span><span class="line"><span class="cl">748.329730   0.985938    <span class="m">7888</span>        71.113640
</span></span><span class="line"><span class="cl">768.471540   0.987500    <span class="m">7900</span>        80.000000
</span></span><span class="line"><span class="cl">788.390297   0.989062    <span class="m">7912</span>        91.424392
</span></span><span class="line"><span class="cl">807.614078   0.990625    <span class="m">7925</span>        106.666667
</span></span><span class="line"><span class="cl">831.889128   0.992188    <span class="m">7938</span>        128.008193
</span></span><span class="line"><span class="cl">845.000015   0.992969    <span class="m">7944</span>        142.227279
</span></span><span class="line"><span class="cl">865.313345   0.993750    <span class="m">7950</span>        160.000000
</span></span><span class="line"><span class="cl">887.424404   0.994531    <span class="m">7956</span>        182.848784
</span></span><span class="line"><span class="cl">909.572865   0.995313    <span class="m">7963</span>        213.356091
</span></span><span class="line"><span class="cl">945.882794   0.996094    <span class="m">7969</span>        256.016385
</span></span><span class="line"><span class="cl">964.014513   0.996484    <span class="m">7972</span>        284.414107
</span></span><span class="line"><span class="cl">985.114464   0.996875    <span class="m">7975</span>        320.000000
</span></span><span class="line"><span class="cl">1021.571080  0.997266    <span class="m">7978</span>        365.764448
</span></span><span class="line"><span class="cl">1057.934456  0.997656    <span class="m">7981</span>        426.621160
</span></span><span class="line"><span class="cl">1093.910902  0.998047    <span class="m">7984</span>        512.032770
</span></span><span class="line"><span class="cl">1110.100395  0.998242    <span class="m">7986</span>        568.828214
</span></span><span class="line"><span class="cl">1126.289888  0.998437    <span class="m">7987</span>        639.795266
</span></span><span class="line"><span class="cl">1142.562404  0.998633    <span class="m">7989</span>        731.528895
</span></span><span class="line"><span class="cl">1158.751897  0.998828    <span class="m">7991</span>        853.242321
</span></span><span class="line"><span class="cl">1174.941389  0.999023    <span class="m">7992</span>        1023.541453
</span></span><span class="line"><span class="cl">1194.670357  0.999121    <span class="m">7993</span>        1137.656428
</span></span><span class="line"><span class="cl">1222.226880  0.999219    <span class="m">7994</span>        1280.409731
</span></span><span class="line"><span class="cl">1249.502214  0.999316    <span class="m">7995</span>        1461.988304
</span></span><span class="line"><span class="cl">1277.058738  0.999414    <span class="m">7995</span>        1706.484642
</span></span><span class="line"><span class="cl">1304.615261  0.999512    <span class="m">7996</span>        2049.180328
</span></span><span class="line"><span class="cl">1318.393523  0.999561    <span class="m">7996</span>        2277.904328
</span></span><span class="line"><span class="cl">1331.890595  0.999609    <span class="m">7997</span>        2557.544757
</span></span><span class="line"><span class="cl">1345.668857  0.999658    <span class="m">7997</span>        2923.976608
</span></span><span class="line"><span class="cl">1385.470751  0.999707    <span class="m">7998</span>        3412.969283
</span></span><span class="line"><span class="cl">1464.641730  0.999756    <span class="m">7998</span>        4098.360656
</span></span><span class="line"><span class="cl">1503.419352  0.999780    <span class="m">7998</span>        4545.454545
</span></span><span class="line"><span class="cl">1543.812709  0.999805    <span class="m">7998</span>        5128.205128
</span></span><span class="line"><span class="cl">1582.590332  0.999829    <span class="m">7999</span>        5847.953216
</span></span><span class="line"><span class="cl">1622.983688  0.999854    <span class="m">7999</span>        6849.315068
</span></span><span class="line"><span class="cl">1661.761311  0.999878    <span class="m">7999</span>        8196.721311
</span></span><span class="line"><span class="cl">1681.150122  0.999890    <span class="m">7999</span>        9090.909091
</span></span><span class="line"><span class="cl">1700.538933  0.999902    <span class="m">7999</span>        10204.081633
</span></span><span class="line"><span class="cl">1721.543478  0.999915    <span class="m">7999</span>        11764.705882
</span></span><span class="line"><span class="cl">1740.932290  0.999927    <span class="m">7999</span>        13698.630137
</span></span><span class="line"><span class="cl">1757.897500  0.999939    <span class="m">8000</span>        16393.442623
</span></span><span class="line"><span class="cl">1757.897500  0.999945    <span class="m">8000</span>        18181.818182
</span></span><span class="line"><span class="cl">1757.897500  0.999951    <span class="m">8000</span>        20408.163265
</span></span><span class="line"><span class="cl">1757.897500  0.999957    <span class="m">8000</span>        23255.813953
</span></span><span class="line"><span class="cl">1757.897500  0.999963    <span class="m">8000</span>        27027.027027
</span></span><span class="line"><span class="cl">1757.897500  0.999969    <span class="m">8000</span>        32258.064516
</span></span><span class="line"><span class="cl">1757.897500  0.999973    <span class="m">8000</span>        37037.037037
</span></span><span class="line"><span class="cl">1757.897500  0.999976    <span class="m">8000</span>        41666.666667
</span></span><span class="line"><span class="cl">1757.897500  0.999979    <span class="m">8000</span>        47619.047619
</span></span><span class="line"><span class="cl">1757.897500  0.999982    <span class="m">8000</span>        55555.555556
</span></span><span class="line"><span class="cl">1757.897500  0.999985    <span class="m">8000</span>        66666.666667
</span></span><span class="line"><span class="cl">1757.897500  0.999986    <span class="m">8000</span>        71428.571429
</span></span><span class="line"><span class="cl">1757.897500  0.999988    <span class="m">8000</span>        83333.333333
</span></span><span class="line"><span class="cl">1757.897500  0.999989    <span class="m">8000</span>        90909.090909
</span></span><span class="line"><span class="cl">1757.897500  0.999991    <span class="m">8000</span>        111111.111111
</span></span><span class="line"><span class="cl">1757.897500  0.999992    <span class="m">8000</span>        125000.000000
</span></span><span class="line"><span class="cl">1757.897500  0.999993    <span class="m">8000</span>        142857.142858
</span></span><span class="line"><span class="cl">1757.897500  0.999994    <span class="m">8000</span>        166666.666668
</span></span><span class="line"><span class="cl">1757.897500  0.999995    <span class="m">8000</span>        199999.999999
</span></span><span class="line"><span class="cl">1757.897500  0.999996    <span class="m">8000</span>        250000.000000
</span></span><span class="line"><span class="cl">1757.897500  0.999997    <span class="m">8000</span>        333333.333336
</span></span><span class="line"><span class="cl">1757.897500  0.999998    <span class="m">8000</span>        500000.000013
</span></span><span class="line"><span class="cl">1757.897500  0.999999    <span class="m">8000</span>        999999.999971
</span></span><span class="line"><span class="cl">1757.897500  1.000000    <span class="m">8000</span>        10000000.000000</span></span></code></pre></div><h3 id="新的demo" class="heading-element">
  <a href="#%e6%96%b0%e7%9a%84demo" class="heading-mark"></a>新的demo</h3><p>动态访问部分写的有点问题，新demo可以实现targeter的计数效果。</p>
<hr>
<h2 id="服务端代码与之前一致" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e4%bb%a3%e7%a0%81%e4%b8%8e%e4%b9%8b%e5%89%8d%e4%b8%80%e8%87%b4" class="heading-mark"></a>服务端代码与之前一致</h2><p>id.txt</p>
<pre tabindex="0"><code>TRA_1_index
TRA_2_index
TRA_3_index
TRA_4_index
TRA_5_index</code></pre><hr>
<p>压测端</p>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bufio&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">vegeta</span> <span class="s">&#34;github.com/tsenart/vegeta/v12/lib&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rate</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Rate</span><span class="p">{</span><span class="nx">Freq</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nx">Per</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">duration</span> <span class="o">:=</span> <span class="mi">4</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="nx">targeter</span> <span class="o">:=</span> <span class="nf">NewCustomTargeter</span><span class="p">(</span><span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Method</span><span class="p">:</span> <span class="s">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">URL</span><span class="p">:</span>    <span class="s">&#34;http://localhost:8080/test&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//测试的实现需要基于Attacker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">attacker</span> <span class="o">:=</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nf">NewAttacker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">metrics</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Metrics</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">res</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">attacker</span><span class="p">.</span><span class="nf">Attack</span><span class="p">(</span><span class="nx">targeter</span><span class="p">,</span> <span class="nx">rate</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="s">&#34;random&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metrics</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metrics</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;99th percentile: %s\n&#34;</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">Latencies</span><span class="p">.</span><span class="nx">P99</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewCustomTargeter</span><span class="p">(</span><span class="nx">target</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">)</span> <span class="nx">vegeta</span><span class="p">.</span><span class="nx">Targeter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//读取id文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">idData</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readRealData</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//cachedArray := make([]bool, len(idData))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">x</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tgt</span> <span class="o">*</span><span class="nx">vegeta</span><span class="p">.</span><span class="nx">Target</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//其中，tgt是作为指针传入的，是需要被修改的。后续HTTP请求的赋值都是来自tgt，所以看做是另外一个返回值会更好一些
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">*</span><span class="nx">tgt</span> <span class="p">=</span> <span class="nx">target</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//tgt.URL += &#34;/custom&#34; + strconv.Itoa(rand.Intn(100))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tgt</span><span class="p">.</span><span class="nx">URL</span> <span class="o">+=</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">idData</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">x</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">idData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//tgt.Header = http.Header{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">readRealData</span><span class="p">()</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//读取id.txt文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">filePath</span> <span class="o">:=</span> <span class="s">&#34;id.txt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">OpenFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">O_RDONLY</span><span class="p">,</span> <span class="mo">0666</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//数据格式为音频id，字符串`TRA_{albumid}_index`，albumid为6-10位数字,index为5位数字以内
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//将其作为字符串读取并写入到slices中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">idData</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1400000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">buf</span><span class="p">.</span><span class="nf">ReadString</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">idData</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">idData</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">idData</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><hr>
<p>服务端部分的结果是</p>
<pre tabindex="0"><code>2022-06-07 16:55:49|14.132µs|200|GET|/test/TRA_1_index|::1|name=TRA_1_index|0 B|0 B||
2022-06-07 16:55:49|20.895µs|200|GET|/test/TRA_2_index|::1|name=TRA_2_index|0 B|0 B||
2022-06-07 16:55:49|20.918µs|200|GET|/test/TRA_3_index|::1|name=TRA_3_index|0 B|0 B||
2022-06-07 16:55:49|21.048µs|200|GET|/test/TRA_4_index|::1|name=TRA_4_index|0 B|0 B||
2022-06-07 16:55:49|12.286µs|200|GET|/test/TRA_5_index|::1|name=TRA_5_index|0 B|0 B||
2022-06-07 16:55:49|28.04µs|200|GET|/test/TRA_1_index|::1|name=TRA_1_index|0 B|0 B||
2022-06-07 16:55:49|49.178µs|200|GET|/test/TRA_2_index|::1|name=TRA_2_index|0 B|0 B||
2022-06-07 16:55:49|29.287µs|200|GET|/test/TRA_3_index|::1|name=TRA_3_index|0 B|0 B||
2022-06-07 16:55:49|45.1µs|200|GET|/test/TRA_4_index|::1|name=TRA_4_index|0 B|0 B||
2022-06-07 16:55:49|17.428µs|200|GET具体的|/test/TRA_5_index|::1|name=TRA_5_index|0 B|0 B||</code></pre><p>这样就可以实现对id.txt中每一行数据的遍历，targeter范例在压测端的<code>NewCustomTargeter</code>，其中的x可以视为一个闭包实现的静态变量</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-03-04 00:00:00">更新于 2024-03-04&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用" data-hashtags="计算机/go,内容/学习笔记,计算机/压力测试,计算机/vegeta"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-hashtag="计算机/go"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://wtysos11.github.io/posts/20220624_vegeta%E5%8E%8B%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%AE%9E%E8%B7%B5/" data-title="Vegeta压测工具学习与使用"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/go/" class="post-tag" title="标签 - 计算机/Go">计算机/Go</a><a href="/tags/%E5%86%85%E5%AE%B9/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-tag" title="标签 - 内容/学习笔记">内容/学习笔记</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/" class="post-tag" title="标签 - 计算机/压力测试">计算机/压力测试</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/vegeta/" class="post-tag" title="标签 - 计算机/Vegeta">计算机/Vegeta</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/20220624_%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E7%BB%BC%E8%BF%B0%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB/" class="post-nav-item" rel="prev" title="布隆过滤器综述文章论文阅读：Optimizing Bloom Filter: Challenges, Solutions, and Comparisons"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>布隆过滤器综述文章论文阅读：Optimizing Bloom Filter: Challenges, Solutions, and Comparisons</a>
      <a href="/posts/20220627_gopherfest2015_go_proverbs_rob_pike/" class="post-nav-item" rel="next" title="Gopherfest 2015：Go Proverbs with Rob Pike">Gopherfest 2015：Go Proverbs with Rob Pike<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/" rel="external nofollow noopener noreferrer">Utterances</a>.
      </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.124.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":30},"comment":{"enable":true,"expired":false,"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"wtysos11/hugo-blog-comment"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"46GYFZ8M81","algoliaIndex":"myblog","algoliaSearchKey":"10948d6f4e69e7991b7a4f9cb5095f13","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
